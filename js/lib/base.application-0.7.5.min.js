define(["underscore","jquery","toolbox"],function(e,t,n){return n.Base.extend({constructor:function(e,n,r,i){this.scriptElement=e;this._action.childInitFunction=i;this.language=n=="fr"?"fr":"en";this.applicationUrl=r;this._parseURI();var s=document.createElement("link");s.setAttribute("href",this.getCSS());s.setAttribute("type","text/css");s.setAttribute("rel","stylesheet");this.styleElement=s;this.scriptElement.parentNode.insertBefore(this.styleElement,this.scriptElement.nextSibling);var o=document.createElement(this.tagName);o.setAttribute("id",this.id);o.setAttribute("data-lang",this.language);this.$el=t(o);this.el=this.$el[0];this.scriptElement.parentNode.insertBefore(this.el,this.styleElement.nextSibling);this._expired(function(e){if(e){return typeof this.renderExpired!=="undefined"?this.renderExpired.call(this):this._action.expired.call(this)}this._launched(function(e){if(!e){return typeof this.renderPrelaunch!=="undefined"?this.renderPrelaunch.call(this):this._action.unlaunched.call(this)}this._action.childInitFunction.call(this)})});this._sendAnalytics()},ajax:function(){var n=e.extend({url:"",cache:false,data:{},dataType:"jsonp",crossDomain:true,onComplete:function(e){}},arguments[0]||{});var r=arguments[1]||null;n.url=n.url.substr(0,4).toLowerCase()==="http"?n.url:this.applicationUrl+n.url;t.support.cors=true;t.ajax(n).done(function(e){r?n.onComplete.call(r,e):n.onComplete(e)})},token:"cfir0xng071mrewe9tcd6ce1r44acwzo",applicationData:{domain:"",subdomain:"",hostname:""},timeCheckUrl:"https://a.irmil.es/cdn/time.php",analyticsUrl:"https://a.irmil.es/api/analytics/1.0/atg",applicationUrl:"/",applicationCSS:{en:"/css/main.css",fr:"/css/main.fr.css"},getCSS:function(){if(!this.applicationCSS){return}var e=typeof this.applicationCSS==="object"?this.applicationCSS[this.language]:this.applicationCSS;return e.substr(0,4).toLowerCase()==="http"?e:this.applicationUrl+e},tagName:"div",id:"fapp",errorcode:{ok:0,error:-1,invalid:-2,ineligible:-3},autoreload:true,attributes:{},toJSON:function(){return this.attributes},toString:function(){return JSON.stringify(this.attributes)},set:function(t,n){this.attributes=this.attributes||{};if(e.isObject(t)){var r=t;var i=this;e.each(e.keys(r),function(e){i.attributes[e]=r[e]})}else{this.attributes[t]=n}},get:function(e){return this.attributes[e]},render:function(){if(typeof this.beforeRender==="function"){this.beforeRender()}this.el.innerHTML=this.template(this.toJSON());if(typeof this.afterRender==="function"){this.afterRender()}return this},language:"en",_resetConstructor:function(){this.$styleElement.remove();this.$el.remove();this.constructor(this.scriptElement,this._action.childInitFunction)},_action:{childInitFunction:function(){},expired:function(){if(typeof this.template_expired!=="undefined"&&this.template_expired!=null){if(typeof this.template_expired==="object"&&this.template_expired.en){this.template=this.language=="fr"&&this.template_expired.fr?this.template_expired.fr:this.template_expired.en}else{this.template=this.template_expired}this.render();return}window.location.href=window.location.origin||window.location.protocol+"//"+window.location.hostname},unlaunched:function(){if(typeof this.template_prelaunch!=="undefined"&&this.template_prelaunch!=null){if(typeof this.template_prelaunch==="object"&&this.template_prelaunch.en){this.template=this.language=="fr"&&this.template_prelaunch.fr?this.template_prelaunch.fr:this.template_prelaunch.en}else{this.template=this.template_prelaunch}this.render();return}window.location.href=window.location.origin||window.location.protocol+"//"+window.location.hostname}},_serverTime:0,_getServerTime:function(){var e=arguments[0];var t=arguments[1]?arguments[1]:null;var n=this;this.ajax({url:this.timeCheckUrl,onComplete:function(r){n._serverTime=typeof r==="object"?parseInt(r.timestamp):r.timestamp;t?e.call(t):e()}})},_expired:function(e){if(typeof this.expires=="undefined"||!this.expires||this.expires.length<1){e.call(this,false);return}this.expireDate=this.expires instanceof Date?this.expires:this._parseDateTime(this.expires);if(!this._serverTime){var t=this;this._getServerTime(function(){t._expiredOnComplete.call(t,e)})}else{this._expiredOnComplete(e)}},_expiredOnComplete:function(e){e.call(this,this._serverTime>this.expireDate.valueOf())},_launched:function(e){if(typeof this.launches=="undefined"||!this.launches||this.launches.length<1){e.call(this,true);return}this.launchDate=this.launches instanceof Date?this.launches:this._parseDateTime(this.launches);if(!this._serverTime){var t=this;this._getServerTime(function(){t._launchedOnComplete.call(t,e)})}else{this._launchedOnComplete(e)}},_launchedOnComplete:function(e){var t=this.launchDate.valueOf()-this._serverTime;e.call(this,t<1);if(this.autoreload&&t>0){var n=this;setTimeout(function(){n._resetConstructor.call(n)},t)}},_dates:{months:{abbr:["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],full:["january","february","march","april","may","june","july","august","september","october","november","december"]}},_parseDateTime:function(t){var n,r,i,s,o;if(typeof t==="object"){o=t.year;s=t.month;i=t.day;r=t.hour<12&&t.ampm&&t.ampm.toLowerCase()=="pm"?t.hour+12:t.hour;r=r===12&&t.ampm&&t.ampm.toLowerCase()=="am"?0:r;n=t.minute}else{var u=t;u=u.replace(/,/g,"");u=u.replace(/\./g," ");u=u.replace(/-/g," ");u=u.replace(/:/g," ");var a=[];e.each(u.split(" "),function(e){var t=parseInt(e),n=isNaN(t)?e:t;a.push(n)});if(isNaN(a[0])){s=a[0].toLowerCase();i=a[1];o=a[2]}else if(!isNaN(a[0])&&a[0].length===4){o=a[0];s=a[1];i=a[2]}else{i=a[0];s=a[1];o=a[2]}r=a[3]<12&&a[5]&&a[5].toLowerCase()=="pm"?a[3]+12:a[3];r=r===12&&t.ampm&&t.ampm.toLowerCase()=="am"?0:r;r=r||"00";n=a[4]||"00"}if(isNaN(s)){s=e.indexOf(this._dates.months.abbr,s.toLowerCase())>-1?e.indexOf(this._dates.months.abbr,s.toLowerCase()):e.indexOf(this._dates.months.full,s.toLowerCase())}else{s--}return new Date(o,s,i,r,n)},_parseURI:function(){this.applicationData.hostname=window.location.host;var t=this.applicationData.hostname.split(".");this.applicationData.subdomain="";while(t.length>2){this.applicationData.subdomain+=t.shift()}this.applicationData.domain=t.join(".");this.uri=this.uri||{};var n=window.location.search.substr(1);var r=n.split("&");var i,s,o,u,a;while(s=r.shift()){o=s.split("=");u=o.shift();a=o.join("=");if(a.length>0){this.uri[u]=e.isArray(this.uriExceptions)&&e.indexOf(this.uriExceptions,a)?a:a.replace(/\+/g," ")}}return this.uri},_sendAnalytics:function(){this.ajax({url:this.analyticsUrl,data:{token:this.token,uri:JSON.stringify(this.uri),domain:this.applicationData.domain,subdomain:this.applicationData.subdomain,language:this.language}})}})})